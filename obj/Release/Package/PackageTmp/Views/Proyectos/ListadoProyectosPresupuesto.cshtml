@model IEnumerable<SAG2.Models.Proyecto>

@{
    ViewBag.Title = "ProyectosPresupuesto";
    Layout = "~/Views/Shared/_Layoutinf.cshtml";
    List<SAG2.Models.DetallePresupuesto> DPresupuesto = (List<SAG2.Models.DetallePresupuesto>)@ViewBag.DetallePresupuesto;
    List<SAG2.Models.Presupuesto> EPresupuesto = (List<SAG2.Models.Presupuesto>)@ViewBag.Presupuestos;
    List<SAG2.Models.Rol> snRol = new List<SAG2.Models.Rol>();
    try
    {
        snRol = (List<SAG2.Models.Rol>)@ViewBag.Roles;

    }
    catch (Exception)
    { }
}

<h2>Proyectos Presupuesto</h2>

<table id="ResultadoTable" class="table table-responsive table-bordered">
    <thead>
        <tr class="label-info">
            <th>COD SAG</th>
            <th> COD SENAME</th>
            <th> NOMBRE PROGRAMA</th>
            <th> FONO</th>
            <th> LINEA</th>
            <th> TIPO</th>
            <th> REGION</th>
            <th> COMUNA</th>
            <th> CALLE</th>
            <th> RES EX</th>
            <th> NUMERO DE PLAZAS</th>
            <th> FECHA DE INICIO</th>
            <th> FECHA DE TERMINO</th>
            <th> DETALLE CONTRATOS</th>
            <th> RESPONSABILIDADES ADMINISTRATIVAS</th>
            <th> VALOR SUBVENCION</th><th> VALOR SUBVENCION MENSUAL</th><th> VALOR SUBVENCION ANUAL</th>
            <th> NUMERO DE CTA CTE</th>   
            <th> BANCO</th>     
            <th>Presupuesto</th>
     </tr>
      </thead>
  <tbody>
@foreach (var item in Model) {
    int SaldoInicial = 0;
    string  Presupuesto = "Sin Presupuesto";
    var rolProyecto = snRol.Where(d => d.ProyectoID == item.ID).ToList();  
    int Pres = 0;
    try {
        int PrID = item.ID;
        SaldoInicial = EPresupuesto.Where(d => d.ProyectoID == PrID).FirstOrDefault().SaldoInicial;
        Presupuesto = "Con Presupuesto";
        Pres = 1;   
    }
    catch (Exception e) { 
        
    }
    
    
    <tr >
        <td> @Html.DisplayFor(modelItem => item.CodCodeni  ) </td>
        <td> @Html.DisplayFor(modelItem => item.CodSename)   </td>
        <td> @Html.DisplayFor(modelItem => item.Nombre ) </td>
        <td> @Html.DisplayFor(modelItem => item.Fono  )  </td>
        <td> @Html.DisplayFor(modelItem => item.TipoProyecto.LineaAtencion.Nombre  )  </td>
        <td> @Html.DisplayFor(modelItem => item.TipoProyecto.Nombre  )  </td>
        <td> @Html.DisplayFor(modelItem => item.Direccion.Comuna.Region.Nombre  )  </td>
        <td> @Html.DisplayFor(modelItem => item.Direccion.Comuna.Nombre  )  </td>
        <td> @Html.DisplayFor(modelItem => item.Direccion.DireccionLista  )  </td>
        <td> @Html.DisplayFor(modelItem => item.Convenio.ResEx   )  </td>
         <td> @Html.DisplayFor(modelItem => item.Convenio.NroPlazas    )  </td>
         <td> 
         @{
                if (item.Convenio.FechaInicio != null) {
                    @Html.Raw(item.Convenio.FechaInicio.Value.ToShortDateString());
                }else{
                     @Html.Raw("<span class='label label-danger'>SIN INFORMACIÓN</span>");
               }
           }
         </td>
         <td> 
         @{
                if (item.Convenio.FechaTermino != null) {
                    @Html.Raw(item.Convenio.FechaTermino.Value.ToShortDateString());
                }else{
                     @Html.Raw("<span class='label label-danger'>SIN INFORMACIÓN</span>");
               }
           }
         </td>
         <td> @Html.DisplayFor(modelItem => item.Convenio.Comentarios  )  </td>
        <td>
                <table style="width: 100%;" class="table table-striped table-bordered table-hover">
        <tbody>
            @{ 
    int i = 1;
                }
            @foreach (SAG2.Models.Rol rol in rolProyecto)
            {
                <tr>
                    <td style="width: 15px;">@i</td>
                    <td>@Html.Raw(rol.TipoRol.Nombre.ToUpper())</td>
                    <td>@Html.Raw(rol.Persona.NombreLista.ToUpper())</td>
                    <td>
                        @if (rol.Persona.CorreoElectronico != null)
                        {
                            <a href="mailto:@Html.Raw(rol.Persona.CorreoElectronico.ToLower())"> @Html.Raw(rol.Persona.CorreoElectronico.ToUpper())</a>
                        }
                        else
                        {
                            @Html.Raw("<span class='label label-danger'>SIN INFORMACIÓN</span>");
                        }
                    </td>
                </tr>
                i++;
            }
        </tbody>
    </table>



        </td>
        <td> 
          @{
               if (item.ValorSubvencion != null)
                        {
                            @Html.Raw("$" + item.ValorSubvencion.Value.ToString("#,###"));
                        }
                        else
                        {
                            @Html.Raw("<span class='label label-danger'>SIN INFORMACIÓN</span>");
                        }
                    }

        </td>
       <td style="width: 16.6%">
                    @{
                        if (item.Convenio.NroPlazas != null && item.ValorSubvencion != null)
                        {
                            @Html.Raw("$" + (item.Convenio.NroPlazas * item.ValorSubvencion.Value).ToString("#,###"));
                        }
                        else
                        {
                            @Html.Raw("<span class='label label-danger'>SIN INFORMACIÓN</span>");
                        }
                    }
                </td>
                 <td style="width: 16.6%">
                    @{
                        if (item.Convenio.NroPlazas != null && item.ValorSubvencion != null)
                        {
                            @Html.Raw("$" + (12 * item.Convenio.NroPlazas * item.ValorSubvencion.Value).ToString("#,###"))
                        }
                        else
                        {
                            @Html.Raw("<span class='label label-danger'>SIN INFORMACIÓN</span>");
                        }
                    }
                </td>
        <td> @Html.DisplayFor(modelItem => item.CuentasCorrientes.LastOrDefault().NumeroLista   ) </td>
           <td> @Html.DisplayFor(modelItem => item.CuentasCorrientes.LastOrDefault().Banco.NombreLista   ) </td>
         <td  @if (Pres == 0){@Html.Raw(" style='background-color: Red;color:white'");}>
              @if (Pres == 0){
                  @Html.Raw(Presupuesto); 
              }else{
                  @SaldoInicial.ToString("#,##0")  
              }
        </td>
            <td>

            </td>
        
    </tr>
}
 </tbody>

</table>